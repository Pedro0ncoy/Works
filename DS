----------------------------- MONITOREO DE BD: --------------------------------------------------
--Q1:Usuarios
SELECT Global_Name,USER_ID, USERNAME, PASSWORD, ACCOUNT_STATUS,LOCK_DATE,EXPIRY_DATE,DEFAULT_TABLESPACE,CREATED,PROFILE,EXTERNAL_NAME, SYSDATE,
ORA_HASH(Global_Name||USER_ID||USERNAME||LOCK_DATE||EXPIRY_DATE||DEFAULT_TABLESPACE||CREATED||PROFILE||EXTERNAL_NAME)AS CHECKSUM 
FROM sys.DBA_USERS,Global_Name ORDER BY USER_ID;

--Q2:Perfiles
SELECT Global_Name,PROFILE,RESOURCE_NAME,RESOURCE_TYPE,LIMIT,SYSDATE,
ORA_HASH(Global_Name||PROFILE||RESOURCE_NAME ||RESOURCE_TYPE|| LIMIT) AS CHECKSUM 
FROM sys.DBA_PROFILES,Global_Name ORDER BY PROFILE, RESOURCE_TYPE;

--Q3:Roles
SELECT Global_Name,GRANTEE, GRANTED_ROLE, ADMIN_OPTION, DEFAULT_ROLE, SYSDATE 
FROM DBA_ROLE_PRIVS,Global_Name WHERE GRANTEE IN (SELECT USERNAME FROM 
sys.dba_users WHERE USERNAME LIKE '%USUARIO%' AND ACCOUNT_STATUS='OPEN')

--Q4:Privilegios
SELECT Global_Name,GRANTEE, OWNER, TABLE_NAME, GRANTOR, PRIVILEGE, GRANTABLE, HIERARCHY, SYSDATE 
FROM sys.DBA_TAB_PRIVS,Global_Name WHERE GRANTEE IN (SELECT USERNAME 
FROM sys.dba_users WHERE USERNAME LIKE '%USUARIO%' AND ACCOUNT_STATUS='OPEN')AND PRIVILEGE!='SELECT'

--Q5:Eventos: Accesos no autorizados: Compartición de cuentas
SELECT Global_Name,OS_USERNAME, USERNAME, USERHOST, TERMINAL, TIMESTAMP, OWNER, OBJ_NAME, ACTION, 
ACTION_NAME, NEW_OWNER, NEW_NAME, OBJ_PRIVILEGE, SYS_PRIVILEGE, ADMIN_OPTION, GRANTEE, AUDIT_OPTION, 
SES_ACTIONS, LOGOFF_TIME, LOGOFF_LREAD, LOGOFF_PREAD, LOGOFF_LWRITE, LOGOFF_DLOCK, COMMENT_TEXT, SESSIONID, 
ENTRYID, STATEMENTID, RETURNCODE, PRIV_USED, CLIENT_ID, ECONTEXT_ID, SESSION_CPU, EXTENDED_TIMESTAMP, PROXY_SESSIONID, 
GLOBAL_UID, INSTANCE_NUMBER, OS_PROCESS, TRANSACTIONID, SCN, SQL_BIND, SQL_TEXT, SYSDATE 
FROM sys.dba_audit_trail,Global_Name WHERE USERNAME LIKE '%USUARIO%' AND (LOWER(SUBSTR(USERNAME,6)))!=OS_USERNAME AND 
TIMESTAMP BETWEEN TO_DATE ('2019-07-01 00:00:01', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('2019-07-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS');

--Q6:Eventos: Accesos no autorizados: Acceso de Ip's no autorizadas
SELECT Global_Name,OS_USERNAME, USERNAME, USERHOST, TERMINAL, TIMESTAMP, OWNER, OBJ_NAME, ACTION,
ACTION_NAME, NEW_OWNER, NEW_NAME, OBJ_PRIVILEGE, SYS_PRIVILEGE, ADMIN_OPTION, GRANTEE, AUDIT_OPTION,
SES_ACTIONS, LOGOFF_TIME, LOGOFF_LREAD, LOGOFF_PREAD, LOGOFF_LWRITE, LOGOFF_DLOCK, COMMENT_TEXT, SESSIONID,
ENTRYID, STATEMENTID, RETURNCODE, PRIV_USED, CLIENT_ID, ECONTEXT_ID, SESSION_CPU, EXTENDED_TIMESTAMP, PROXY_SESSIONID,
GLOBAL_UID, INSTANCE_NUMBER, OS_PROCESS, TRANSACTIONID, SCN, SQL_BIND, SQL_TEXT, SYSDATE 
FROM sys.dba_audit_trail,Global_Name WHERE (substr(comment_text,instr(comment_text,'HOST=')+5,11)) NOT LIKE '10.%' AND
TIMESTAMP BETWEEN TO_DATE ('2019-07-01 00:00:01', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('2019-07-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS');

--Q7:Eventos: Monitoreos de DML, DLL: Modificación de tablas sensibles.
SELECT Global_Name,OS_USERNAME,USERNAME,USERHOST,TERMINAL,TIMESTAMP,OWNER,OBJ_NAME,ACTION,ACTION_NAME,
SESSIONID,PRIV_USED,EXTENDED_TIMESTAMP, SYSDATE FROM DBA_AUDIT_TRAIL, Global_Name 
WHERE ACTION_NAME NOT LIKE 'LOG%' AND USERNAME NOT IN (SELECT GRANTEE FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE='DBA') AND
TIMESTAMP BETWEEN TO_DATE ('2019-07-01 00:00:01', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('2019-07-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS');

 ------------------------------ DISPONIBILIDAD DE DATA: LOG-AUDITORIA -----------------------
 SELECT MAX(TIMESTAMP), MIN(TIMESTAMP) FROM DBA_AUDIT_TRAIL --HAY LOG-AUDITORIA DESDE HASTA.

 -------prueba----
SELECT*FROM SYS.DBA_TAB_COLUMNS WHERE owner= 'MYSCHEMA' AND COLUMN_NAME LIKE '%MYCAMPO%'
SELECT*FROM SYS.DBA_ROLE_PRIVS WHERE GRANTEE = 'USUARIO'
SELECT*FROM sys.DBA_TAB_PRIVS WHERE GRANTEE = 'USUARIO'
 
